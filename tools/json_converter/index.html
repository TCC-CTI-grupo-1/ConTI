<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=<h>, initial-scale=1.0">
    <title>Document</title>
</head>
<body onload="load()">
    <h1>
        Inserir JSON no banco de dados
    </h1>

        <label>
            Arquivo JSON: 
            <input type="file" id="file">
        </label>
        <button onclick="convert()">Clique aqui para converter</button>
    <script>
        class Question {
            constructor(enunciation,additionalText,subject,questionNumber,questionYear,alternatives,hasImage,hasLatex)
            {
                this.enunciation = enunciation;
                this.additionalText = additionalText;
                this.subject = subject; // Trigonometria
                this.questionNumber = questionNumber;
                this.questionYear = questionYear;
                this.questionCreator = "VUNESP"; // Ex: VUNESP.
                this.prova = "CTI"; // CTI
                this.alternatives = alternatives; // {"A":sdasd, "B":23,... Tem que ser assim pq pode ter A-D ou A-E}
                this.hasImage = hasImage; 
                this.hasLatex = hasLatex;
            }
        }
        class Answer {
            constructor(answer)
            {
                this.answer = answer;
                this.is_correct = false;
            }
        }
        class Area {
            constructor(areaName)
            {
                this.areaName = areaName
            }
        }
        function load() {
            const fileInput = document.getElementById('file');
            window.convert = function() {
                const files = fileInput.files;
                if (files.length === 0) {
                    alert("Nenhum arquivo selecionado!");
                    return;
                }

                const file = files[0];
                if (file.name.split('.').pop().toLowerCase() !== 'json') {
                    alert("Arquivo deve ser JSON!");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const json = JSON.parse(ev.target.result);
                        console.log(json);
                        for (const q of json) {
                            const alt = [ new Answer(q.alternativaA),new  Answer(q.alternativaB), new Answer(q.alternativaC), new Answer(q.alternativaD)];
                            if (q.alternativaE != undefined) {
                                alt.push(new Answer(q.alternativaE));
                            }
                            const question = new Question(q.enunciado, q.textoAdicional,new Area(q.materia), q.numero, q.ano, alt, q.imagem == 'on', false);
                            const sqlQuery = `INSERT INTO question (question_text, additional_info, area_id, question_number, question_year, question_creator, test_name, hasImage) VALUES ('${question.enunciation}', '${question.additionalText}', '${question.subject}', '${question.questionNumber}', '${question.questionYear}', '${question.questionCreator}', '${question.prova}', '${question.hasImage}');`;

                            const altQueries = alt.map(a => `INSERT INTO answer (question_id, answer, is_correct) VALUES (LAST_INSERT_ID(), '${a.answer}', '${a.is_correct}');`);

                            
                        }
                    } catch (e) {
                        alert("Erro ao ler o arquivo JSON: " + e.message);
                    }
                };
                reader.onerror = function() {
                    alert("Erro ao ler o arquivo!");
                };
                reader.readAsText(file);
            };

            let oi = "aoaoa";

            // Send the variable to the server
            fetch('echo.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ oi: oi })
            })
            .then(response => response.text())
            .then(data => {
                console.log('Response from server:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>